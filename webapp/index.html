<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgentBot — WebApp (Minimal Secure)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 2rem; background:#f7f8fb; color:#111; }
    .card { background:#fff; padding:1.5rem; border-radius:8px; box-shadow:0 2px 8px rgba(16,24,40,0.06); max-width:880px; margin:auto;}
    h1 { margin:0 0 .5rem 0; }
    p.meta { color:#555; margin-top: .5rem; }
    .field { font-weight:600; }
    .small { color:#666; font-size:.9rem; }
    pre { background:#f3f4f6; padding:.75rem; border-radius:6px; overflow:auto; white-space:pre-wrap; word-break:break-word; }
    .controls { margin-top: .75rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    button { padding:.5rem .75rem; border-radius:6px; border:1px solid #ddd; background:#f8f9fb; cursor:pointer; }
    .muted { color:#666; font-size:.9rem; }
    .small-note { font-size:.85rem; color:#666; margin-top:.5rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1 id="greeting">Привет!</h1>
    <p class="meta">Минимальная WebApp страница. Данные пользователей переданы через Telegram initData и безопасно проверены backend.</p>

    <div>
      <p><span class="field">Telegram username:</span> <span id="username">—</span></p>
      <p><span class="field">Telegram id:</span> <span id="tid">—</span></p>
      <p><span class="field">Auth date:</span> <span id="auth_date">—</span></p>
    </div>

    <p class="small">WebApp отправляет initData на backend /auth/init. В ответ выводится проверённая информация (и JWT если включено).</p>

    <h3>Raw verified response</h3>
    <pre id="response">—</pre>

    <h3>Diagnostics</h3>
    <p class="small">Отображаются значения, доступные странице (window.Telegram, WebApp.initData, location.href/hash) и строки, которые будет отправлена на бэкенд.</p>
    <pre id="diag">—</pre>

    <div class="controls">
      <button id="send-raw">Send raw initData to /auth/init</button>
      <button id="reload">Reload</button>
    </div>

    <p class="small-note">Если вы ожидаете, что WebApp откроется внутри Telegram, откройте кнопку "Open WebApp" в официальном клиенте (mobile/desktop), не в внешнем браузере. Если Telegram открывает наружный браузер, включённый fallback попытается взять tgWebAppData из hash.</p>
  </div>

  <script src="static/js/app.js"></script>
  <script>
    // Helper functions for diagnostics and manual send
    function getRawTgWebAppDataFromHash() {
      const hash = window.location.hash || "";
      const m = hash.match(/(?:#|&)?tgWebAppData=([^&]+)/);
      return (m && m[1]) ? m[1] : null; // percent-encoded fragment (raw)
    }

    function decodePercentFragment(fragment) {
      try {
        return decodeURIComponent(fragment);
      } catch (e) {
        return fragment;
      }
    }

    function buildDiag() {
      const diag = {
        timestamp: new Date().toISOString(),
        windowTelegram: !!window.Telegram,
        hasWebAppObj: !!(window.Telegram && window.Telegram.WebApp),
        initDataSync: null,
        locationHref: window.location.href,
        locationSearch: window.location.search,
        locationHash: window.location.hash,
        raw_tgWebAppData_fragment: null,
        decoded_inner_init_data: null
      };

      try {
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
          diag.initDataSync = window.Telegram.WebApp.initData;
        }
      } catch (e) {
        diag.initDataSync = null;
      }

      const rawFrag = getRawTgWebAppDataFromHash();
      if (rawFrag) {
        diag.raw_tgWebAppData_fragment = rawFrag;
        diag.decoded_inner_init_data = decodePercentFragment(rawFrag);
      }

      return diag;
    }

    function showDiag() {
      const d = buildDiag();
      document.getElementById('diag').textContent = JSON.stringify(d, null, 2);
      return d;
    }

    // Manual send: send either raw tgWebAppData fragment (percent-encoded)
    // or WebApp.initData if present.
    document.getElementById('send-raw').addEventListener('click', async function() {
      const diag = showDiag();
      let initDataCandidate = null;
      let sentAs = null;

      if (diag.raw_tgWebAppData_fragment) {
        initDataCandidate = diag.raw_tgWebAppData_fragment; // raw percent-encoded
        sentAs = "raw_percent_encoded_fragment_from_hash";
      } else if (diag.initDataSync) {
        initDataCandidate = diag.initDataSync;
        sentAs = "window.Telegram.WebApp.initData";
      } else {
        alert("No initData found in WebApp (try opening from Telegram client or check location.hash).");
        return;
      }

      // Show what we are about to send
      document.getElementById('response').textContent = "Manual send (init_data candidate):\n" + initDataCandidate + "\n\nSending to /auth/init...";

      // POST to backend
      try {
        const resp = await fetch('/auth/init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ init_data: initDataCandidate })
        });
        let json;
        try {
          json = await resp.json();
        } catch (e) {
          json = { error: "invalid json from backend", status: resp.status, text: await resp.text() };
        }
        document.getElementById('response').textContent = "Manual send result (sent_as: " + sentAs + "):\n" + JSON.stringify(json, null, 2);
      } catch (e) {
        document.getElementById('response').textContent = "Manual send failed: " + String(e);
      }
    });

    document.getElementById('reload').addEventListener('click', () => location.reload());

    // show diag immediately on load
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", showDiag);
    } else {
      showDiag();
    }
  </script>
</body>
</html>