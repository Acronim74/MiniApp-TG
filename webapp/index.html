<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgentBot — WebApp (Minimal Secure)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 2rem; background:#f7f8fb; color:#111; }
    .card { background:#fff; padding:1.5rem; border-radius:8px; box-shadow:0 2px 8px rgba(16,24,40,0.06); max-width:880px; margin:auto;}
    h1 { margin:0 0 .5rem 0; }
    p.meta { color:#555; margin-top: .5rem; }
    .field { font-weight:600; }
    .small { color:#666; font-size:.9rem; }
    pre { background:#f3f4f6; padding:.75rem; border-radius:6px; overflow:auto; white-space:pre-wrap; word-break:break-word; }
    .controls { margin-top: .75rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    button { padding:.5rem .75rem; border-radius:6px; border:1px solid #ddd; background:#f8f9fb; cursor:pointer; }
  </style>
</head>
<body>
  <div class="card">
    <h1 id="greeting">Привет!</h1>
    <p class="meta">Минимальная WebApp страница. Данные пользователей переданы через Telegram initData и безопасно проверены backend.</p>

    <div>
      <p><span class="field">Telegram username:</span> <span id="username">—</span></p>
      <p><span class="field">Telegram id:</span> <span id="tid">—</span></p>
      <p><span class="field">Auth date:</span> <span id="auth_date">—</span></p>
    </div>

    <p class="small">WebApp отправляет initData на backend /auth/init. В ответ выводится проверённая информация (и JWT если включено).</p>

    <h3>Raw verified response</h3>
    <pre id="response">—</pre>

    <h3>Diagnostics</h3>
    <p class="small">Отображаются значения, доступные странице (window.Telegram, WebApp.initData, location.href/hash).</p>
    <pre id="diag">—</pre>

    <div class="controls">
      <button id="send-raw">Send raw initData to /auth/init</button>
      <button id="reload">Reload</button>
    </div>
  </div>

  <script src="static/js/app.js"></script>
  <script>
    // small helper for manual testing: send raw percent-encoded tgWebAppData (if present) or initData from Telegram API
    document.getElementById('send-raw').addEventListener('click', async function() {
      // try raw tgWebAppData in hash first (percent-encoded)
      const hash = window.location.hash || "";
      const match = hash.match(/(?:#|&)?tgWebAppData=([^&]+)/);
      let initDataCandidate = null;
      if (match && match[1]) {
        initDataCandidate = match[1]; // raw percent-encoded fragment (we send as-is)
      } else {
        try {
          if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
            initDataCandidate = window.Telegram.WebApp.initData;
          }
        } catch (e) {
          // ignore
        }
      }

      if (!initDataCandidate) {
        alert("No initData found in WebApp (try opening from Telegram client or check location.hash).");
        return;
      }

      // POST to backend
      try {
        const resp = await fetch('/auth/init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ init_data: initDataCandidate })
        });
        const json = await resp.json();
        document.getElementById('response').textContent = "Manual send result: " + JSON.stringify(json, null, 2);
      } catch (e) {
        document.getElementById('response').textContent = "Manual send failed: " + String(e);
      }
    });

    document.getElementById('reload').addEventListener('click', () => location.reload());
  </script>
</body>
</html>